\input preamble.tex

\setupindenting[medium,yes]

\starttext
\defineNewPicture{
}
\startchapter[title={Introduction}]
This document describes some of the internals of \MetaPost\ + \ConTeXt\ rendition of Byrne's Euclid.  

Byrne's Euclid is known for it's neat interaction between text and graphics. Naive way of making this interaction happen lies through lots of tedious manual work, which is not so tedious nowdays, but still we can hope to get off cheaper. To automate these things we need to set up same neat interaction between what we want to see and what we mean, as we want to see between text and graphics. I. e., when we want to see a picture of a red angle in text, we mean not the color, but some particular angle, that is taken from some particular place, and if angle there changes color from red to blue, angle in text should also do that automatically.

One can think of many ways to achieve this. Among the simplest is introduction of some markup language that can both describe graphical elements and reference them in text, and that's precisely what *TeX and MetaPost pair should be ideal for.

The project consists of following files: 

\startitemize
\item{\tt byrne.mp} — \MetaPost\ library responsible for handling graphics.
\item{\tt preamble.tex} — a bunch of \ConTeXt\ macros responsible for interaction between \MetaPost\ code and text.
\item{\tt preamble_be.tex} — \ConTeXt\ macros that are more book-specific and make little sense outside of the book.
\item{\tt byrne_context.tex} — \ConTeXt\ file with Byrne's book.
\item{\tt lettrines/lettrines.mp} — \MetaPost\ code that reads {\tt lettrines/lettrineslist.txt} generated by {\tt byrne_context.tex} and produces lettrines.
\stopitemize

In order to generate the book, simply run:

{\tt context byrne_context.tex} 

That will produce pdf file of the book, but without generated lettrines. To obtain generated lettrines, run the following inside the lettrines folder.

{\tt mpost lettrines.mp} 

Note that this should be done after {\tt context byrne_context.tex}  first run, because {\tt lettrineslist.txt} generated in process contains  list of lettrines, that will be generated.

After that run {\tt context byrne_context.tex} again, to get the book with lettrines.
\stopchapter

\startchapter[title={\MetaPost\ part}]
All the drawing is done with \MetaPost. All the \MetaPost\ code is independent from \ConTeXt\ and can be used anywhere (e. g. with \LaTeX).

\startsection[title={Global variables}]
Some of the parameters are stored in global variables, instead of being passed as arguments, most important of them are listed below.

\startsubsection[title={scaleFactor}]
All sizes are multiplied by {\tt scaleFactor}.
\stopsubsection
\startsubsection[title={angleScale}]
Angles are generally drawn as circle sectors, and circle radii are multiplied by {\tt angleScale}.
\stopsubsection
\startsubsection[title={magnitudeScale}]
Magnitude symbols are scaled according to {\tt magnitudeScale}.
\stopsubsection
\stopsection

\startsection[title={Lines}]
\startsubsection[title={byLineRender (expr a, b, col, dp, th, c, d, ct, dt, s, sf)}]
All functions that make straight lines call this one in the end. Returns a picture of a line with given properties.

{\tt a, b} — of pair type, coordinates of line ends.

{\tt col} — of color type, line color.

{\tt dp} — of numeric type, line dashedness. 0 for solid line, 1 for dashed.

{\tt th} — of numeric type, line thickness. 0 for thick line, 1 for thin, 2 for hairline.

{\tt c, d} — of pair type, coordinates of distant ends of adjacent lines, to give line ands appropriate joint (when equal to {\tt a} or {\tt b} respectively, line ends are chopped straight).

{\tt ct, cd} — of numeric type, types of line end joints. 0 for miter joint, 1 for lap joint.

{\tt s} — of numeric type, perpendicular line shift, proportional to line thickness.

{\tt sf} — scale factor.
\stopsubsection

\startsubsection[title={byLineDefineWithName (suffix a, b) (expr col, dp, th) (suffix lineName)}]
Defines a new line with a given name. Returns nothing.

{\tt a, b} — of suffix type, coordinates of line ends.

{\tt lineName} — of suffix type, line name.

{\tt col, dp, th} — same as {\tt byLineRender}.
\stopsubsection

\startsubsection[title={byLineDefine (suffix a, b) (expr col, dp, th)}]
Defines a new line. Name is assigned automatically. Returns nothing.

{\tt a, b} — of suffix type, coordinates of line ends.

{\tt col, dp, th} — same as {\tt byLineRender}.
\stopsubsection

\startsubsection[title={byLineStylize (expr c, d, ct, dt, s) (suffix lineName)}]
Defines additional attributes for a line with a given name. Returns nothing.

{\tt lineName} — of suffix type, line name.

{\tt c, d, ct, dt, s} — same as {\tt byLineRender}.
\stopsubsection

\startsubsection[title={byLine (suffix a, b) (expr col, dp, th)}]
Defines a new line. Name is assigned automatically. Returns a picture of that line.

{\tt a, b} — of suffix type, coordinates of line ends.

{\tt col, dp, th} — same as {\tt byLineRender}.
\stopsubsection

\startsubsection[title={byLineFull (suffix a, b) (expr col, dp, th, c, d, ct, dt, s)}]
Defines a new line with additional attributes. Name is assigned automatically. Returns a picture of that line.

{\tt a, b} — of suffix type, coordinates of line ends.

{\tt col, dp, th, c, d, ct, dt, s} — same as {\tt byLineRender}.
\stopsubsection

\startsubsection[title={byLineWithName (suffix a, b) (expr col, dp, th) (suffix 
lineName)}]
Defines a new line with a given name. Returns a picture of that line.

{\tt a, b} — of suffix type, coordinates of line ends.

{\tt lineName} — of suffix type, line name.

{\tt col, dp, th} — same as {\tt byLineRender}.
\stopsubsection

\startsubsection[title={byNamedLineFull(expr c, d, ct, dt, s) (suffix lineName)}]
Produces already defined line with a given name, supplied with additional attributes. Returns a picture of that line.

{\tt lineName} — of suffix type, line name.

{\tt c, d, ct, dt, s} — same as {\tt byLineRender}.
\stopsubsection

\startsubsection[title={byNamedLine(text linesList)}]
Produces a number of already defined lines (separated by comma). Returnes a picture of that lines.

{\tt linesList} — of text type, comma separated line names.
\stopsubsection

\startsubsection[title={byNamedLineSeq(expr s) (text linesList)}]
Produces a number of already defined with  appropriate joints for adjacent lines (separated by comma). All the lines can be shifted perpendicularly. Specified line shift is saved. Returnes a picture of that lines.

{\tt s} — of numeric type, as in {\tt byLineRender}, perpendicular line shift, proportional to line thickness,  but s is not passed directly to {\tt byLineRender} (which can result in lines shifted in different directions along the sequence), but adjusted so, that lines are all shifted similarly.

{\tt linesList} — of text type, comma separated line names.
\stopsubsection

\startsubsection[title={byMarkLine(expr pos, col) (suffix lineName)}]
Produces a tick on a line with a given name. Returns a picture of that tick.

{\tt pos} — of numeric type, position of a tick on a line, 0 to 1.

{\tt col} — of color type, line color.

{\tt lineName} — of suffix type, line name.
\stopsubsection

\startsubsection[title={byNamedMarkLine(suffix lineName)}]
Produces a picture of a tick on a given line. Returns a picture of that tick.

{\tt lineName} — of suffix type, line name.
\stopsubsection

\startsubsection[title={byNamedCompoundLineSized(expr cu, pw) (text linesList)}]
Produces a horizontal line with colors and proportions of the given lines. Returns a picture of that line.

{\tt cu} — of numeric type, line length, which will be represented $1:1$.

{\tt pw} — of numeric type, power factor, which determines how strongly line length is changed to be closer to {\tt cu}. ${\tt cu}^{1-\frac{1}{\tt pw}} \times \sqrt[{\tt pw}]{length}$.

{\tt linesList} — of text type, comma separated line names.
\stopsubsection

\startsubsection[title={byNamedCompoundLine(expr l) (text linesList)}]
Produces a horizontal line of a geven length with colors and proportions of the given lines. Returns a picture of that line.

{\tt l} — of numeric type, horizontal line's length.

{\tt linesList} — of text type, comma separated line names.
\stopsubsection
\stopsection

\startsection[title={Arcs and circles}]
\startsubsection[title={byArcRender(expr o, r, b, e, col, dp, th, s, et)}]
All functions that make arcs and circles call this one in the end. Returns a picture of an arc with given properties.

{\tt o} — of pair type, coordinates of arc center.

{\tt r} — of numeric type, arc radius.

{\tt b, e} — of numeric type, ends of an arc, in octants (well, not exactly, but fullcircle has length of eight and it's convenient to use arctime on fullcircle).

{\tt col} — of color type, arc color

{\tt dp} — of numeric type, arc dashedness. 0 for solid line, 1 for dashed

{\tt th} — of numeric type, arc thickness. 0 for thick line, 1 for thin, 2 for hairline

{\tt s} — of numeric type, arc radius modifier, proportional to line thickness.

{\tt et} — of numeric type, type of arc ends, 0 for stumps, 1 for oblique
\stopsubsection

\startsubsection[title={byArc (expr o, r, b, e, col, dp, th, s, et) (suffix arcName)}]
Defines a new arc with a given name. Returns a picture of that arc.

{\tt o, r, b, e, col, dp, th, s, et} — same as {\tt byArcRender}.

{\tt arcName} — of suffix type, arc name.
\stopsubsection
\startsubsection[title={byNamedArcExact(text arcslist)}]
Produces already defined arcs, including {\tt s} and {\tt et} paramters. Returns a picture of that arcs.

{\tt arcslist} — of text type, comma separated arc names.
\stopsubsection
\startsubsection[title={byNamedArc(text arcslist)}]
Produces already defined arcs, with {\tt s} and {\tt et} set to 0. Returns a picture of that arcs.

{\tt arcslist} — of text type, comma separated arc names.
\stopsubsection
\startsubsection[title={byCircleDefine (expr o, r, col, dp, th, s) (suffix circleName)}]
Defines a new circle with a given name. Returns nothing.

{\tt o, r, col, dp, th, s} — same as {\tt byArcRender}.

{\tt circleName} — of suffix type, circle name.
\stopsubsection
\startsubsection[title={byCircle (expr o, r, col, dp, th, s) (suffix circleName)}]
Defines a new circle with a given name. Returns a picture of that circle.

{\tt o, r, col, dp, th, s} — same as {\tt byArcRender}.

{\tt circleName} — of suffix type, circle name.
\stopsubsection
\startsubsection[title={byNamedCircle(text circlesList)}]
Produces already defined circles, with {\tt s} set to 0. Returns a picture of that circles.

{\tt circlesList} — of text type, comma separated circle names.
\stopsubsection
\stopsection

\startsection[title={Arbitrary figures}]
\startsubsection[title={byArbitraryFigureDefine(expr p, col, dp, th) (suffix arbitraryFigureName)}]
Defines a new arbitrary path with a given name. Returns nothing.

{\tt p} — of path type, arbitrary path.

{\tt col} — of color type, path color.

{\tt dp} — of numeric type, path dashedness. 0 for solid line, 1 for dashed.

{\tt th} — of numeric type, path thickness. 0 for thick line, 1 for thin, 2 for hairline.

{\tt arbitraryFigureName} — of suffix type, figure name.
\stopsubsection
\startsubsection[title={byArbitraryFigure(expr p, col, dp, th) (suffix arbitraryFigureName)}]
Defines a new arbitrary path with a given name. Returns a picture of that path.

{\tt p, col, dp, th, arbitraryFigureName} — same as {\tt byArbitraryFigureDefine}.
\stopsubsection
\startsubsection[title={byNamedArbitraryFigure(text arbitraryFiguresList)}]
Produces already defined arbitrary figures. Returns a picture of that figures.

{\tt arbitraryFiguresList} — of text type, comma separated arbitrary figure names.
\stopsubsection
\stopsection

\startsection[title={Filled figures}]
\startsubsection[title={byFilledCircleSegment (expr o, r, b, e, col) (suffix filledCircleSegmentName)}]
Defines a new filled circle segment with a given name. Returns a picture of that segment.

{\tt o} — of pair type, coordinates of circle center.

{\tt r} — of numeric type, circle radius.

{\tt b, e} — of numeric type, ends of a segment, in octants.

{\tt col} — of color type, segment color

{\tt filledCircleSegmentName} — of suffix type, filled circle segment name.
\stopsubsection
\startsubsection[title={byNamedFilledCircleSegment(text filledCircleSegmentList)}]
Produces already defined filled circle segment. Returns a picture of that segment.

{\tt filledCircleSegmentList} — of text type, comma separated circle segment names.
\stopsubsection
\startsubsection[title={byFilledCircleSector (expr o, r, b, e, col) (suffix filledCircleSectorName)}]
Defines a new filled circle sector with a given name. Returns a picture of that sector.

{\tt o} — of pair type, coordinates of circle center.

{\tt r} — of numeric type, circle radius.

{\tt b, e} — of numeric type, ends of a sector, in octants.

{\tt col} — of color type, sector color

{\tt filledCircleSectorName} — of suffix type, filled circle sector name.
\stopsubsection
\startsubsection[title={byNamedFilledCircleSector(text filledCircleSectorList)}]
Produces already defined filled circle sector. Returns a picture of that sector.

{\tt filledCircleSectorList} — of text type, comma separated circle sector names.
\stopsubsection
\startsubsection[title={byPolygon(expr p, col) (suffix polygonName)}]
Defines a new filled polygon with a given name. Returns a picture of that polygon.

{\tt p} — of path type, filled polygon outline.

{\tt col} — of color type, polygon color.

{\tt polygonName} — of suffix type, polygon name.
\stopsubsection
\startsubsection[title={byNamedPolygon(text polygonsList)}]
Produces already defined filled polygon. Returns a picture of that polygon.

{\tt polygonsList} — of text type, comma separated polygon names.
\stopsubsection
\stopsection

\startsection[title={Angles}]
\startsubsection[title={byAngleDefine(suffix a, b, c) (expr col, sty) (suffix angleName)}]
Defines a new angle with a given name. Returns nothing.

{\tt a, b, c} — of suffix type, coordinates of angle points.

{\tt col} — of color type, angle color.

{\tt sty} — of numeric type, angle style, 0 for solid sector, 1 for arc, 2 for dashed arc, 3 for series of thin arcs.

{\tt angleName} — of suffix type, angle name.
\stopsubsection
\startsubsection[title={byAngle(suffix a, b, c) (expr col, sty) (suffix angleName)}]
Defines a new angle with a given name. Returns a picture of that angle.

a, b, c, col, sty, angleName — same as byAngleDefine.
\stopsubsection
\startsubsection[title={byAngleExtended(suffix a, b, c) (expr col, sty) (suffix angleName) (text optionalColors)}]
Defines a new angle with a given name with additional colors. Returns a picture of that angle.

{\tt optionalColors} — of text type, a list of additional colors (currently only affects angles with sty = 1).

{\tt a, b, c, col, sty, angleName} — same as {\tt byAngleDefine}.
\stopsubsection
\startsubsection[title={byNamedAngle(text anglesList)}]
Produces already defined angles. Returns a picture of that angles.

{\tt anglesList} — of text type, comma separated angle names.
\stopsubsection
\startsubsection[title={byNamedAngleSidesFull(text anglesList) (text linesList)}]
Produces a picture of side parts of given lines adjacent to given angles. Returns a piture of that side segments.

{\tt anglesList} — of text type, comma separated angle names.

{\tt linesList} — of text type, comma separated line names.
\stopsubsection
\startsubsection[title={byNamedAngleDummySides(text anglesList)}]
Produces a picture of side parts of thin black lines adjacent to given angles. Returns a picture of that side segments.

{\tt anglesList} — of text type, comma separated angle names.
\stopsubsection
\startsubsection[title={byNamedAngleSides(text anglesList) (text linesList)}]
Produces a picture of side parts of given lines adjacent to given angles. Returns a piture of that side segments on top of picture of given angles.

{\tt anglesList} — of text type, comma separated angle names.

{\tt linesList} — of text type, comma separated line names.
\stopsubsection
\startsubsection[title={twoRightAngles}]
Produces a generic picture of a flat angle, like this \drawTwoRightAngles , takes no arguments. Returns a picture of a flat angle.
\stopsubsection
\startsubsection[title={rightAngle}]
Produces a generic picture of a right angle, like this \drawRightAngle , takes no arguments. Returns a picture of a right angle.
\stopsubsection
\stopsection

\startsection[title={Magnitudes}]
\startsubsection[title={byMagnitudeSymbolDefine (expr shp, col, sty) (suffix magnitudeSymbolName)}]
Defines a new magnitude symbol with a given name. Also defines a magnitude of the same name consisting of one symbol. Returns nothing.

{\tt shp} — of string type, shape of magnitude symbol: {\tt "circle", "semicircleUp", "semicircleDown", "sectorDown", "sectorUp", "wedgeDown", "wedgeUp", "square", "halfsquare", "rhombus", "halfrhombusUp", "miniTriangleUp", "miniTriangleDown", "miniSquare", "miniCircle"}.

{\tt col} — of color type, magnitude symbol color.

{\tt sty} — of numeric type, magnitude symbol style, 0 for solid, 1 for outline.

{\tt magnitudeSymbolName} — of suffix type, magnitude symbol name.
\stopsubsection
\startsubsection[title={byNamedMagnitudeSymbol (expr n, hor) (suffix magnitudeSymbolName)}]
Produces already defined magnitude symbol. Returns a picture of magnitude symbol.

{\tt n} — of numeric type, number of magnitude symbols in row.

{\tt hor} — of boolean type, false for horizontally stacked symbols, true for verticaly stacked symbols.

{\tt magnitudeSymbolName} — of suffix type, magnitude symbol name.
\stopsubsection
\startsubsection[title={byMagnitudeDefine (suffix magnitudeName) (expr al, hor) (text rowsList) (text magnitudeSymbolsList)}]
Defines a magnitude with a given name, composited of given symbols. Returns nothing.

{\tt magnitudeName} — of suffix type, magnitude name.

{\tt al} — of numeric type, magnitude alignment, 0 for center, -1 for left, 1 for right.

{\tt hor} — of boolean type, if true, magnitude is aligned vertically.

{\tt rowsList} — of text type, comma delimited list of row lengths.

{\tt magnitudeSymbolsList} — of text type, comma delimited magnitude symbol names.
\stopsubsection
\startsubsection[title={byNamedMagnitude (expr excl) (suffix magnitudeName)}]
Produces a picture ofmagniture. Returns a piture of that magnitude.

{\tt excl} — of numeric type, what rows to exclude, $0$ — exclude nothing, $-n$ — exclude n-th row (or column if {\tt hor}=true), $n$ — exclude everything but n-th row (or column if {\tt hor}=true).

{\tt magnitudeName} — of suffix type, magnitude symbol name.
\stopsubsection
\stopsection
\stopchapter

\startchapter[title={\ConTeXt\ part}]
\ConTeXt\ was chosen for its convenient and unified ways of dealing with \MetaPost\ code. 

\startsection[title={Core macros}]
\startsubsection[title={defineNewPicture[\#1][\#2]\{\#3\}}]
Defines a new picture, returns nothing.

\#1, optional — {\tt scaleFactor} after main picture.

\#2, optional — {\tt scaleFactor} for main picture.

\#3 — picture itself.
\stopsubsection
\startsubsection[title={drawFromCurrentPicture[\#1][\#2]\{\#3\}}]
Draws a picture based on current picture.

\#1, optional — vertical alignment, middle for middle, anything else for bottom.

\#2, optional — name for drawn picture (instead of drawing it again, one can just call it with \\name).

\#3 — picture itself.
\stopsubsection
\startsubsection[title={drawUnitLine[\#1]\{\#2\}}]
Draws a horizontal line with  fixed length.

\#1, optional — line length ({\tt 1cm} by default).

\#2 — comma separated list of line names.
\stopsubsection
\startsubsection[title={drawProportionalLine\{\#1\}}]
Draws a horizontal line with  proportional length.

\#1 — comma separated list of line names.
\stopsubsection
\startsubsection[title={drawSizedLine[\#1]\{\#2\}}]
Draws a horizontal line with corrected proportional length.

\#1, optional — length, that will be reproduced $1:1$ ({\tt 2cm} by default).

\#2 — comma separated list of line names.
\stopsubsection
\startsubsection[title={drawTwoRightAngles}]
Draws a flat angle.
\stopsubsection
\startsubsection[title={drawRightAngle}]
Draws a right angle.
\stopsubsection
\startsubsection[title={drawAngle\{\#2\}}]
Draws an angle.

\#1 — comma separated list of angle names.
\stopsubsection
\startsubsection[title={drawPolygon[\#1][\#2]\{\#3\}}]
Draws polygons.

\#1, \#2, both optional — same as {\tt drawFromCurrentPicture}.

\#3 — comma separated list of polygons.
\stopsubsection
\startsubsection[title={drawCircle[\#1][\#2]\{\#3\}}]
Draws circles.

\#1, optional — same as {\tt drawFromCurrentPicture}.

\#2, optional — {\tt scaleFactor} for drawn circles.

\#3 — comma separated list of circles.
\stopsubsection
\startsubsection[title={drawArc[\#1][\#2]\{\#3\}}]
Draws arcs.

\#1, optional — same as {\tt drawFromCurrentPicture}.

\#2, optional — {\tt scaleFactor} for drawn arcs.

\#3 — comma separated list of arcs.
\stopsubsection
\startsubsection[title={drawLine[\#1][\#2]\{\#3\}}]
Draws lines.

\#1, \#2, both optional — same as {\tt drawFromCurrentPicture}.

\#3 — comma separated list of lines.
\stopsubsection
\startsubsection[title={drawMagnitude[\#1][\#2]\{\#3\}}]
Draws magnitude.

\#1, optional — same as {\tt drawFromCurrentPicture}.

\#2, optional — what to exclude from magnitude.

\#3 — magnitude name.
\stopsubsection
\stopsection

\startsection[title={Book-specific macros}]
Some macros are book specific and are of no good use outside of it. They are listed below.

\startsubsection[title={drawCurrentPicture}]
\stopsubsection
\startsubsection[title={initialIndentation}]
\stopsubsection
\startsubsection[title={putLettrine}]
\stopsubsection
\startsubsection[title={regularLettrine}]
\stopsubsection
\startsubsection[title={problem}]
\stopsubsection
\startsubsection[title={problemNP}]
\stopsubsection
\startsubsection[title={qed}]
\stopsubsection
\startsubsection[title={drawCurrentPictureInMargin}]
\stopsubsection
\startsubsection[title={figureInMargin}]
\stopsubsection
\stopsection

\stopchapter

\startchapter[title={Lettrines}]
Generated lettrines are not exactly a part of the project and can be safely and easily substituted with anything else, or used anywhere without any dependency on other components.

If generated lettrine files (with names like A0.mps, B1.mps, A1.mps and so on) are missing in lettrines folder, lettrine placing algorithm looks for regular pre-drawn lettrines (with names like A.pdf, B.pdf) if they are also missing, it draws squares with letters inside as placeholders.

In order to generate lettrines, run {\tt mpost lettrines.mp} inside lettrines folder after generating the book.
\stopchapter

\stoptext
%\closeout \lettrineslist
